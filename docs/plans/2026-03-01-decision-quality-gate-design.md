# Decision Quality Gate â€” Design

**Date:** 2026-03-01
**Spec:** 009.5
**Status:** Approved

---

## Problem

Tier 2 review found 43% of logged decisions are noise â€” chat fragments ("Done! âœ…"), status updates ("On it! ðŸš€"), and duplicates. Root cause: auto-deliberation records a decision for every non-informational turn in `decision`, `task`, and `debug` frames. The `_is_informational()` filter catches some garbage but misses status updates, completion announcements, and action reports.

## Approach: Refined Three-Layer Gate

Each check lives where its data naturally exists.

### Layer 1: Expanded Pre-Record Filtering (`_is_informational()`)

**File:** `nous/cognitive/layer.py`

Pattern-based detection â€” "is this response a decision?" All checks that can be answered from response shape go here.

**New patterns in `_INFO_PATTERNS`:**
- Completion/status: `"done!", "done.", "completed!", "finished!", "on it!", "created!", "pushed to", "review complete", "task is running"`
- Transition phrases: `"now let me", "next i'll", "moving on to", "let me check", "let me look", "i'll start", "starting with"`
- Report phrases: `"here's the result", "here are the results", "pr #", "pr created", "spec scores"`

**New `_is_action_report()` method:**
- Triggers when: `tool_results` exist AND response first 300 chars contain 2+ report markers ("done", "created", "updated", "fixed", "merged", "pushed", "committed", "deployed", "sent", "saved", "completed", "finished", "resolved", "applied")
- Wired as check #5 in `_is_informational()`

**Frame change:**
- Remove `task` from `_DELIBERATION_FRAMES`: `{"decision", "task", "debug"}` â†’ `{"decision", "debug"}`
- Agents in task frame can still call `record_decision` tool explicitly (bypasses all filtering)
- Monitor for 1 week; add `task` back with stricter filter if legitimate decisions are missed

### Layer 2: Embedding-Based Deduplication

**File:** `nous/cognitive/deliberation.py`, `nous/brain/brain.py`

Before creating a decision record, check if a similar one was recorded recently.

**New `_is_duplicate()` on `DeliberationEngine`:**
- Called at top of `start()` before creating a decision
- Fetches recent decisions for same `agent_id` + `session_id` within last 5 minutes via new `Brain.get_recent_decisions()`
- Embeds incoming description using existing `EmbeddingProvider`
- Compares against stored embeddings on recent decisions (already generated by `Brain.record()`)
- Threshold: 0.85 cosine similarity (same as `ConversationDeduplicator`)
- Fallback: keyword containment coefficient when embeddings unavailable
- Session-scoped to prevent cross-session suppression
- On duplicate: `start()` returns `None`, no decision created

**New `Brain.get_recent_decisions()`:**
- `async def get_recent_decisions(agent_id, since, limit=5, session_id=None, session=None) -> list[DecisionSummary]`
- Query: `WHERE agent_id = X AND created_at > cutoff AND active = true`, optionally filtered by session_id
- Returns descriptions + embeddings for comparison

### Layer 3: Quality Gate at Finalize

**File:** `nous/cognitive/deliberation.py`

Content-based rules that need post-turn data. Catches noise that passed Layers 1 and 2.

**Four rules:**
1. Description too short: `< 20 chars` after strip
2. Default confidence + high stakes: `confidence == 0.5 AND stakes in ("high", "critical")` â€” placeholder from `start()`, never deliberated
3. Chat pattern prefix: description starts with "done", "on it", "here's", "got it", "sure", "okay", "alright", "working on", "let me", "i'll"
4. Error template: contains "encountered an error processing your request"

**On failure:** soft-delete (`active=false`) + log rejection reason. Preserves audit trail via existing Nous convention. `finalize()` returns `None`.

## Integration Flow

```
User message arrives
  â†’ pre_turn(): frame selected
    â†’ Frame NOT in {"decision", "debug"}? â†’ no deliberation
    â†’ Frame in deliberation set:
      â†’ Layer 2: _is_duplicate()? â†’ return None, no decision created
      â†’ deliberation.start() â†’ decision_id created

  â†’ Tool loop executes, response generated

  â†’ post_turn():
    â†’ Layer 1: _is_informational()? â†’ delete decision, done
    â†’ Layer 3: quality gate in finalize() â†’ soft-delete if fails, done
    â†’ Passes all gates â†’ decision persisted
```

## Edge Cases

- **`record_decision` tool in task frame:** Works as before. Bypasses deliberation entirely, calls `Brain.record()` directly. No frame check, no dedup, no quality gate.
- **Dedup returns None:** `pre_turn()` sets `decision_id = None`. `post_turn()` checks `if decision_id:` â€” cleanly skips.
- **Quality gate rejects:** Decision soft-deleted. Brief active window doesn't matter â€” nothing queries mid-turn.
- **Embedding provider unavailable:** Dedup falls back to keyword similarity. Quality gate doesn't use embeddings. Graceful degradation.
- **Debug frame:** Stays in auto-deliberation. Monitor noise rate separately.

## Files Touched

| File | Changes |
|------|---------|
| `nous/cognitive/layer.py` | Expand `_INFO_PATTERNS`, add `_is_action_report()`, wire into `_is_informational()` |
| `nous/cognitive/deliberation.py` | Remove `task` from frames, add `_is_duplicate()` in `start()`, add quality gate in `finalize()` |
| `nous/brain/brain.py` | Add `get_recent_decisions()` method |
| `tests/test_deliberation.py` | Tests for dedup, quality gate, frame change |
| `tests/test_cognitive_layer.py` | Tests for new informational patterns, action report detection |

## Not In Scope

- One-time cleanup of existing noise decisions (separate maintenance task)
- Changes to `record_decision` tool path
- Changes to `QualityScorer` or guardrail enforcement
- New DB tables, columns, or migrations

## Success Criteria

| Metric | Before | Target |
|--------|--------|--------|
| Noise rate (non-decisions in DB) | 43% | < 5% |
| Duplicate decisions | Present | 0 |
| Legitimate decisions missed | 0 | < 5% |
| Error template decisions | 4 found | 0 |

## Design Choices & Rationale

| Choice | Why |
|--------|-----|
| Remove `task` from auto-deliberation | Task frame activates on action verbs. 43% noise proves over-recording is worse than under-recording. `record_decision` tool is the explicit escape hatch. |
| Embedding-based dedup over Jaccard | Reuses existing infrastructure. Catches paraphrases. One embedding call per `start()` is acceptable latency. |
| Soft-delete over hard delete | Follows existing Nous convention (`active` boolean). Preserves audit trail. Existing queries already filter on `active=true`. |
| Split gate placement | Pattern checks in `_is_informational()` (where response shape is evaluated). Content checks at `finalize()` (where post-turn data exists). Each check where its data lives. |
| Keep debug frame | Debug sessions contain genuine diagnostic decisions. Monitor separately. |
