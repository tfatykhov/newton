# 005.2 Direct API Rewrite — Implementation Plan

**Source spec:** `005.2-direct-api-rewrite.md`
**Review team:** nous-arch-052, nous-api-052, nous-devil-052
**Review decision IDs:** `b761d571`, `45b454b3`, `64b69e40`
**Synthesis decision ID:** `c6128a0f`
**Date:** 2026-02-23

## Review Summary

3 reviewers produced 49 findings. After dedup: **8 P0 blockers, 9 P1 issues, ~10 P2/P3**.

### Convergence Matrix (P0 Blockers)

| Finding | Arch | API | Devil | Fix |
|---------|------|-----|-------|-----|
| Missing `anthropic-version` header | P0 | P0 | P1 | Add to httpx default headers |
| Conv history in system prompt, not messages[] | P0 | P1 | P1 | Use `_format_messages()` for messages array |
| Tool loop must preserve assistant tool_use msgs | — | P0 | P1 | Append full assistant response + user tool_results |
| `record_decision` field "decision" vs "description" | P1 | P1 | P0 | Keep "description" from existing code |
| `record_decision` drops required category/stakes | P1 | P1 | P0 | Keep 4 required fields from existing schema |
| `dispatch(args)` vs closures expect `**kwargs` | — | — | P0 | Use `handler(**args)` |
| `ToolDispatcher.__init__` missing `_schemas` | P1 | P1 | P0 | Add `self._schemas = {}` |
| Bash workspace dir config removed | — | — | P0 | Add `workspace_dir` config field |

### Lead Overrides

- **Frame-gated tools (D5):** Implement but sync with `_get_frame_instructions()`. P2, not blocking.
- **Retry logic:** Simple inline retry (1x for 429/500), no `tenacity` dep. P2.
- **Prompt caching:** Keep D9 approach but make conditional on auth type. P2.

## Implementation Phases

### Phase A: Config + API Client (~45 min)

**Files:** `nous/config.py`, `nous/api/runner.py`

1. **Config changes** (`config.py`):
   - Remove: `sdk_max_turns`, `sdk_permission_mode`, `sdk_workspace`, `sdk_allowed_tools`
   - Add: `max_turns: int = 10`, `api_base_url: str = "https://api.anthropic.com"`, `api_timeout_connect: int = 10`, `api_timeout_read: int = 120`, `workspace_dir: str = "/tmp/nous-workspace"`

2. **httpx.AsyncClient** (`runner.py`):
   - Create in `start()`, close with `await self._http.aclose()` in `close()`
   - Default headers: `anthropic-version: 2023-06-01`, `content-type: application/json`
   - Auth header per D1: Bearer token takes precedence over x-api-key
   - Timeout: `httpx.Timeout(connect=settings.api_timeout_connect, read=settings.api_timeout_read, write=10, pool=10)`
   - Connection limits: `httpx.Limits(max_connections=10, max_keepalive_connections=5)`

3. **`_call_api()` method** (`runner.py`):
   - Single API call: POST `/v1/messages` with `model`, `max_tokens`, `system`, `messages`, `tools`
   - Parse response: extract `content` blocks and `stop_reason`
   - Error handling: parse `error.type` + `error.message` from response body
   - Simple retry: 1x for 429 (with `Retry-After` header), 1x for 500/529

### Phase B: Tool Loop + Dispatcher (~1h)

**Files:** `nous/api/tools.py`, `nous/api/runner.py`

1. **ToolDispatcher class** (`tools.py`):
   ```python
   class ToolDispatcher:
       def __init__(self):
           self._handlers: dict[str, Callable] = {}
           self._schemas: dict[str, dict] = {}

       def register(self, name: str, handler: Callable, schema: dict):
           self._handlers[name] = handler
           self._schemas[name] = schema

       async def dispatch(self, name: str, args: dict) -> tuple[str, bool]:
           """Returns (result_text, is_error)."""
           handler = self._handlers.get(name)
           if not handler:
               return f"Unknown tool: {name}", True
           try:
               result = await handler(**args)  # **kwargs unpacking
               # Extract text from MCP-format response
               return result["content"][0]["text"], False
           except Exception as e:
               return f"Tool error: {e}", True

       def tool_definitions(self) -> list[dict]:
           return [
               {"name": n, "description": s.get("description", ""), "input_schema": s}
               for n, s in self._schemas.items()
           ]
   ```

2. **Tool registration** — Keep existing closures from `create_nous_tools()`, register with existing `_*_SCHEMA` dicts. Schema field names stay as-is ("description", not "decision"). Required fields stay as-is.

3. **Remove** `create_nous_mcp_server()` function and all `claude_agent_sdk` imports from `tools.py`.

4. **`_tool_loop()` method** (`runner.py`):
   - Build messages array using `_format_messages()` (not system prompt injection)
   - System prompt = cognitive context + frame instructions only (stable, cacheable)
   - Loop:
     ```
     while turns < max_turns:
         response = await _call_api(system_prompt, messages, tools)
         if response.stop_reason != "tool_use":
             break  # handles end_turn, max_tokens, etc.
         # Append FULL assistant response (all content blocks)
         messages.append({"role": "assistant", "content": response.content})
         # Dispatch ALL tool_use blocks, collect results
         tool_results = []
         for block in response.content:
             if block.type == "tool_use":
                 text, is_error = await dispatcher.dispatch(block.name, block.input)
                 tool_results.append({
                     "type": "tool_result",
                     "tool_use_id": block.id,
                     "content": text,
                     "is_error": is_error,
                 })
         # All results in SINGLE user message
         messages.append({"role": "user", "content": tool_results})
         turns += 1
     ```

5. **Message dataclass update** — Extend `Message.content` to store structured blocks for tool_use/tool_result roundtrips, OR accumulate messages as raw dicts in the tool loop (simpler).

6. **Reflection path** — `end_conversation()` calls `_call_api()` directly without tool loop (no tools needed for reflection).

7. **Frame-gated tools** — Implement D5 `FRAME_TOOLS` map. Filter `dispatcher.tool_definitions()` by active frame. Sync `_get_frame_instructions()` to only mention available tools.

### Phase C: Built-in Tools (~45 min)

**File:** `nous/api/builtin_tools.py` (new)

1. **bash tool:**
   - `asyncio.create_subprocess_shell` with configurable timeout (default 30s, max 300s)
   - Working directory: `settings.workspace_dir`
   - Output truncation at 100KB
   - Return stdout + stderr

2. **read_file tool:**
   - `asyncio.to_thread(Path(path).read_text)` — no `aiofiles` dependency
   - Path validation: must be under workspace_dir or explicit allowed paths
   - Size limit: 1MB
   - Support offset/limit for large files

3. **write_file tool:**
   - `asyncio.to_thread(Path(path).write_text, content)` — no `aiofiles` dependency
   - Path validation: same as read_file
   - Auto-create parent directories

4. **Registration:** Register all built-in tools in dispatcher at startup, gated by frame.

### Phase D: Cleanup + Tests (~1h)

**Files:** `pyproject.toml`, `Dockerfile`, `docker-compose.yml`, `.env.example`, `nous/main.py`, `tests/`

1. **pyproject.toml:**
   - Remove `claude-agent-sdk>=0.1.39` from `[project.optional-dependencies].runtime`
   - Keep `mcp>=1.0` in runtime (MCP server in `mcp.py` still uses it)
   - No new deps needed (no aiofiles, no tenacity)

2. **Dockerfile:**
   - Remove Node.js installation and Claude Code CLI
   - Keep `mkdir -p /tmp/nous-workspace`
   - Result: ~224MB smaller image

3. **docker-compose.yml:**
   - Remove: `NOUS_SDK_MAX_TURNS`, `NOUS_SDK_PERMISSION_MODE`, `NOUS_SDK_WORKSPACE`
   - Add: `NOUS_MAX_TURNS`, `NOUS_API_BASE_URL` (optional), `NOUS_API_TIMEOUT_READ` (optional)

4. **.env.example:**
   - Remove SDK section
   - Add new config fields with defaults

5. **main.py:**
   - Update logging to reference new config field names
   - Remove any `sdk_*` references

6. **Test updates:**
   - `test_runner.py`: Rename all `_call_sdk` mocks to `_call_api`, remove `create_nous_mcp_server` patches, rewrite `test_start_credentials` to verify httpx headers, delete `test_permission_mode_from_settings`, add tool loop tests
   - `test_tools.py`: Keep closure tests, add ToolDispatcher tests (registration, dispatch, unknown tool, error handling)
   - New `test_builtin_tools.py`: bash timeout, path validation, output truncation
   - New `test_tool_loop.py`: mock API responses with tool_use, verify loop termination on end_turn/max_tokens/max_turns

## Files Changed (Complete)

### Modified
| File | Changes |
|------|---------|
| `nous/config.py` | Remove sdk_* settings, add max_turns/api_base_url/api_timeout_*/workspace_dir |
| `nous/api/runner.py` | Replace _call_sdk with _call_api + _tool_loop, httpx client lifecycle, messages array |
| `nous/api/tools.py` | Remove SDK wrapper, add ToolDispatcher class, keep closures + schemas |
| `pyproject.toml` | Remove claude-agent-sdk dep |
| `Dockerfile` | Remove Node.js/Claude Code CLI |
| `docker-compose.yml` | Replace SDK env vars with new config vars |
| `.env.example` | Replace SDK section with new config section |
| `nous/main.py` | Update config references |
| `tests/test_runner.py` | Migrate all mocks from _call_sdk to _call_api |
| `tests/test_tools.py` | Add ToolDispatcher tests |

### New
| File | Purpose |
|------|---------|
| `nous/api/builtin_tools.py` | bash, read_file, write_file handlers |
| `tests/test_builtin_tools.py` | Built-in tool unit tests |
| `tests/test_tool_loop.py` | Tool loop integration tests |

## Acceptance Criteria

- [ ] API key auth works (x-api-key header)
- [ ] Auth token works (Bearer header, takes precedence)
- [ ] Single-turn chat without tools works
- [ ] Multi-turn conversation maintains history in messages array
- [ ] Tool loop executes and terminates on end_turn
- [ ] Tool loop terminates on max_tokens
- [ ] Tool loop terminates on max_turns limit
- [ ] Parallel tool calls dispatched, results in single user message
- [ ] record_decision tool works end-to-end
- [ ] recall_deep tool works end-to-end
- [ ] Frame-gated tool filtering active
- [ ] bash tool with timeout
- [ ] read_file/write_file with path validation
- [ ] Reflection on conversation end works
- [ ] Docker image builds without Node.js
- [ ] All existing tests pass (migrated)
- [ ] All new tests pass

## Team Structure

| Role | Agent | Scope |
|------|-------|-------|
| python-engineer | Implementation | Phases A, B, C — all source code |
| test-engineer | Tests | Phase D — all test code + config cleanup |
| code-reviewer | Review | Final pass on all changes |
