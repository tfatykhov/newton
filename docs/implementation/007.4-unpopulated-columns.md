# 007.4 — Fix Unpopulated Database Columns

> **Status:** Implemented
> **Priority:** P0
> **Issue:** #36
> **Estimated effort:** ~2-3 hours

## Problem

Three columns are defined in the schema but never written:

| Table | Column | Expected Source | Current Value |
|-------|--------|-----------------|---------------|
| `system.events` | `session_id` | Event emitters | Always NULL |
| `heart.episodes` | `user_id` | Telegram/REST caller | Always NULL |
| `heart.episodes` | `user_display_name` | Telegram/REST caller | Always NULL |
| `system.agents` | `last_active` | Updated on each turn | Always NULL |

## Root Cause

### events.session_id
The `EventBus.emit()` method creates Event records but the session_id from the emitting context isn't passed through. Event handlers have `event.session_id` available but it's populated from the event data dict, not from the ORM column.

### episodes.user_id / user_display_name
`CognitiveLayer.pre_turn()` accepts `user_display_name` parameter and passes it to episode creation, but:
- The Telegram bot doesn't pass the Telegram user ID or display name
- The REST API doesn't pass caller identity

### agents.last_active
No code ever updates this column. The `system.agents` table is seeded on startup but never touched again.

## Solution

### Fix 1: Wire session_id into Events

```python
# event_bus.py — emit()

async def emit(self, event_type: str, data: dict, agent_id: str,
               session_id: str | None = None, session: AsyncSession | None = None):
    """Emit an event with optional session context."""
    event = Event(
        agent_id=agent_id,
        session_id=session_id,  # Now passed through
        event_type=event_type,
        data=data,
    )
    ...
```

Update all callers to pass `session_id`:
- `cognitive/layer.py` — `pre_turn`, `post_turn` (has session_id in scope)
- `handlers/*.py` — handlers receive events with session_id, pass it when re-emitting

### Fix 2: Pass user identity from Telegram and REST

```python
# telegram_bot.py — _chat_streaming()

# Extract Telegram user info
user_id = str(update.message.from_user.id)
display_name = update.message.from_user.first_name

# Pass to chat endpoint or directly to cognitive layer
payload = {
    "message": text,
    "session_id": session_id,
    "user_id": user_id,
    "user_display_name": display_name,
}
```

```python
# rest.py — POST /chat

@router.post("/chat")
async def chat(request: ChatRequest):
    # ChatRequest gets optional user_id + user_display_name fields
    result = await cognitive.turn(
        agent_id=request.agent_id or default_agent,
        session_id=request.session_id,
        user_input=request.message,
        user_id=request.user_id,
        user_display_name=request.user_display_name,
    )
```

```python
# cognitive/layer.py — pre_turn()

# Pass user info to episode creation
episode = await self._heart.start_episode(
    EpisodeInput(
        title=user_input[:100],
        summary=user_input,
        trigger="user_message",
        participants=[agent_id, user_id] if user_id else [agent_id],
        tags=[],
    ),
    session_id=session_id,
    user_id=user_id,
    user_display_name=user_display_name,
    session=session,
)
```

### Fix 3: Update agents.last_active

Add a lightweight update at the start of each turn:

```python
# cognitive/layer.py — pre_turn()

# Update agent's last_active timestamp
await session.execute(
    update(Agent)
    .where(Agent.agent_id == agent_id)
    .values(last_active=func.now())
)
```

This is a single UPDATE per turn — negligible overhead.

## Schema Changes

### ChatRequest (REST API)

```python
class ChatRequest(BaseModel):
    message: str
    session_id: str | None = None
    agent_id: str | None = None
    platform: str | None = None
    user_id: str | None = None           # NEW
    user_display_name: str | None = None  # NEW
```

### EpisodeManager.start()

```python
async def start(self, input: EpisodeInput, session_id: str,
                user_id: str | None = None,
                user_display_name: str | None = None,
                session: AsyncSession | None = None) -> EpisodeDetail:
    episode = Episode(
        ...
        user_id=user_id,
        user_display_name=user_display_name,
    )
```

## Files Changed

| File | Change |
|------|--------|
| `nous/event_bus.py` | Add session_id param to emit() (~5 lines) |
| `nous/cognitive/layer.py` | Pass session_id to emit, user info to episodes, update last_active (~15 lines) |
| `nous/telegram_bot.py` | Extract and pass user_id + display_name (~5 lines) |
| `nous/api/rest.py` | Add user_id/user_display_name to ChatRequest (~5 lines) |
| `nous/api/schemas.py` | Update ChatRequest model (~2 lines) |
| `nous/heart/episodes.py` | Accept user_id/user_display_name in start() (~5 lines) |
| `tests/test_unpopulated_columns.py` | Tests (~100 lines) |

**Estimated:** ~40 lines modified, ~100 lines tests

## Notes

- All changes are backwards compatible — new params are optional with None defaults
- `last_active` update is per-turn, not per-event — avoids excessive writes
- Telegram user info is available from `update.message.from_user` (already in scope)
- REST callers can optionally pass user identity; not required
