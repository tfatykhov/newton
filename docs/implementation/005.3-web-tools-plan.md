# 005.3 — Web Tools: Search & Fetch — Implementation Plan

> **Status:** Ready to Build  
> **Priority:** P1  
> **Estimated Effort:** ~2.5 hours  
> **Prereq:** 005.2 ✅ (shipped)  
> **Branch:** `feature/005.3-web-tools`

---

## Overview

Add two new built-in tools to Nous — `web_search` and `web_fetch` — enabling the agent to retrieve real-time information from the web. Both tools are **disabled by default** behind a feature flag and follow the existing `builtin_tools.py` registration pattern exactly.

---

## Current State Analysis

| What | State |
|---|---|
| `httpx` | ✅ Already a core dep — no new packages needed for fetch |
| `ToolDispatcher` | ✅ Implemented in `tools.py` — plug-and-play |
| `register_builtin_tools()` pattern | ✅ Clean pattern in `builtin_tools.py` to follow exactly |
| `FRAME_TOOLS` in `runner.py` | ⚠️ Has `"question": ["recall_deep"]` — needs `web_search`, `web_fetch` added |
| `config.py` | ⚠️ No `web_search_enabled` or `search_api_key` settings yet |
| `.env.example` | ⚠️ No web search env vars |
| `test_builtin_tools.py` | ✅ Perfect pattern for new `test_web_tools.py` to follow |
| A search API client | ❌ Not present — need to choose a provider |

---

## Pre-Decision: Search API Provider

| Provider | Pros | Cons |
|---|---|---|
| **Brave Search** | Cheap (~$3/1k queries), clean REST API, privacy-aligned | Needs API key |
| **Tavily** | AI-focused, returns clean summaries natively | Pricier |
| **SerpAPI** | Google results, very reliable | Most expensive |
| **DuckDuckGo (free)** | No key needed | Unofficial, fragile, rate-limited |

**Recommendation: Brave Search** — cheap, reliable, clean JSON responses, privacy-first ethos aligns with Nous. `httpx` is sufficient to call it — no SDK needed.

---

## Phase A — Config & Settings (~15 min)

**File:** `nous/config.py`

Add 4 new settings:

```python
# Web tools (005.3)
web_search_enabled: bool = False
web_search_api_key: str = Field("", validation_alias="BRAVE_SEARCH_API_KEY")
web_search_max_results: int = 5
web_fetch_max_bytes: int = 500 * 1024  # 500KB
```

**File:** `.env.example`

```env
# Web Tools (005.3)
NOUS_WEB_SEARCH_ENABLED=false
BRAVE_SEARCH_API_KEY=your_brave_key_here
NOUS_WEB_SEARCH_MAX_RESULTS=5
```

---

## Phase B — Tool Handlers (~60 min)

**New file:** `nous/api/web_tools.py`

### `web_search_tool(query, max_results)`

```
1. Validate web_search_enabled (return friendly disabled message if not)
2. POST to https://api.search.brave.com/res/v1/web/search
   Headers: Accept: application/json, X-Subscription-Token: <key>
   Params:  q=<query>, count=<max_results>
3. Parse JSON → extract title, url, description for each result
4. Format as numbered list → return _mcp_response(text)
5. Handle errors:
   - 401 → clear auth error (bad API key)
   - 429 → rate limit message
   - timeout → timeout message
   - no results → "no results found" message
```

### `web_fetch_tool(url)`

```
1. Validate URL scheme is http/https (block file://, ftp://, etc.)
2. httpx.AsyncClient.get(url, follow_redirects=True, timeout=30)
   Custom User-Agent: "Nous-Agent/1.0 (+https://github.com/tfatykhov/nous)"
3. Check Content-Type — only process text/html and text/plain
4. Truncate response to web_fetch_max_bytes (500KB default)
5. Strip HTML tags → extract readable text using stdlib html.parser
6. Return clean text → _mcp_response(text)
7. Handle errors:
   - non-200 status → HTTP error message
   - timeout → timeout message
   - non-text content (PDF, image) → rejected with clear message
   - SSL errors → SSL error message
```

**Key design notes:**
- **No new dependencies** — `html.parser` is stdlib, `httpx` already present
- Both return `_mcp_response(text)` for full `ToolDispatcher` compatibility
- `_workspace_dir` pattern NOT needed (web tools don't touch filesystem)
- Closures inject `settings` at registration time (same pattern as builtins)

### Tool Schemas

```python
_WEB_SEARCH_SCHEMA = {
    "type": "object",
    "description": "Search the web and return relevant results",
    "properties": {
        "query": {"type": "string", "description": "Search query"},
        "max_results": {
            "type": "integer",
            "default": 5,
            "minimum": 1,
            "maximum": 10,
            "description": "Number of results to return",
        },
    },
    "required": ["query"],
}

_WEB_FETCH_SCHEMA = {
    "type": "object",
    "description": "Fetch and read the text content of a URL",
    "properties": {
        "url": {"type": "string", "description": "URL to fetch (http/https only)"},
    },
    "required": ["url"],
}
```

### Registration Function

```python
def register_web_tools(dispatcher: ToolDispatcher, settings: Settings) -> None:
    if not settings.web_search_enabled:
        return  # Don't register tools at all if disabled

    async def _web_search(query: str, max_results: int = 5):
        return await web_search_tool(query, max_results, _settings=settings)

    async def _web_fetch(url: str):
        return await web_fetch_tool(url, _settings=settings)

    dispatcher.register("web_search", _web_search, _WEB_SEARCH_SCHEMA)
    dispatcher.register("web_fetch", _web_fetch, _WEB_FETCH_SCHEMA)
```

---

## Phase C — Wire Into Runner (~15 min)

**File:** `nous/api/runner.py`

Update `FRAME_TOOLS` — add web tools to `question` frame:

```python
FRAME_TOOLS: dict[str, list[str]] = {
    ...
    "question": ["recall_deep", "web_search", "web_fetch"],  # ← add web tools
    ...
    # "task" / "problem_solving" already gets everything via ["*"]
}
```

Update `_get_frame_instructions()` for `question` frame:

```python
elif frame_id == "question":
    return (
        "## Tool Instructions\n\n"
        "You are in a QUESTION frame. Use `recall_deep` to search memory first. "
        "If the answer requires current or external information, use `web_search` "
        "to find it, then `web_fetch` to read specific pages if needed."
    )
```

**File:** `nous/main.py` (or wherever tools are wired at startup)

```python
from nous.api.web_tools import register_web_tools

# After existing register_builtin_tools() call:
register_web_tools(dispatcher, settings)
```

---

## Phase D — Tests (~45 min)

**New file:** `tests/test_web_tools.py`

Following `test_builtin_tools.py` pattern. HTTP calls are mocked — no real API calls in CI.

| Test | What It Verifies |
|---|---|
| `test_web_search_returns_results` | Happy path — results formatted correctly |
| `test_web_search_disabled` | Returns "disabled" message when `web_search_enabled=False` |
| `test_web_search_no_results` | Handles empty results gracefully |
| `test_web_search_rate_limited` | 429 → friendly rate limit message |
| `test_web_search_invalid_key` | 401 → clear auth error message |
| `test_web_fetch_success_html` | Fetches HTML, strips tags, returns clean text |
| `test_web_fetch_success_plaintext` | `text/plain` returned as-is |
| `test_web_fetch_invalid_scheme` | `file://`, `ftp://` → rejected before HTTP call |
| `test_web_fetch_timeout` | Timeout → friendly error message |
| `test_web_fetch_non_text_content` | PDF, image → rejected with clear message |
| `test_web_fetch_truncation` | Content > 500KB → truncated with `[truncated]` marker |
| `test_register_web_tools_disabled` | No tools registered when `web_search_enabled=False` |
| `test_register_web_tools_enabled` | Both tools registered when `web_search_enabled=True` |

---

## Files Changed Summary

| File | Change | Est. Lines |
|---|---|---|
| `nous/api/web_tools.py` | **NEW** — handlers, schemas, registration | ~150 |
| `nous/config.py` | **MODIFY** — add 4 new settings | +8 |
| `nous/api/runner.py` | **MODIFY** — add web tools to `question` frame + frame instructions | +10 |
| `nous/main.py` (or rest.py) | **MODIFY** — call `register_web_tools()` at startup | +3 |
| `.env.example` | **MODIFY** — add 3 env vars | +5 |
| `tests/test_web_tools.py` | **NEW** — 13 test cases | ~200 |

**Total: ~350 lines, 2 new files, 4 small modifications.**

---

## Effort Estimate

| Phase | Time |
|---|---|
| A — Config & Settings | 15 min |
| B — Tool Handlers | 60 min |
| C — Wiring into Runner | 15 min |
| D — Tests | 45 min |
| **Total** | **~2.5 hours** |

---

## Definition of Done

- [ ] `NOUS_WEB_SEARCH_ENABLED=false` by default (feature-flagged off)
- [ ] `web_search` and `web_fetch` available in `question` and `task` frames
- [ ] All tests pass in CI with mocked HTTP (no real API calls in tests)
- [ ] Graceful errors for: disabled, bad key, timeout, rate limit, bad URL, non-text content
- [ ] No new required dependencies (only stdlib + existing `httpx`)
- [ ] `.env.example` updated with new vars
- [ ] Frame instructions updated for `question` frame
