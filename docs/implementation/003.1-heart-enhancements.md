# 003.1: Heart Enhancements — Contradiction Detection & Domain Compaction

**Status:** Shipped (PR #6)
**Priority:** P1 — Hardens Heart before Cognitive Layer builds on it
**Prerequisites:** 003-heart-module (merged)
**Origin:** [research/013 — LangChain Agent Builder Memory Lessons](../research/013-langchain-memory-lessons.md)

## Objective

Two enhancements to `FactManager` addressing gaps identified from LangChain's production memory system:

1. **Contradiction detection** — warn when a new fact potentially contradicts an existing one
2. **Domain compaction tracking** — emit events when a category accumulates too many facts

## Motivation

LangChain's biggest lesson: agents accumulate specific facts instead of generalizing. Their solution was manual prompting. Ours is automated detection + event-driven compaction.

Second lesson: silently storing contradicting facts leads to confused context. Better to surface contradictions and let the Cognitive Layer resolve them.

## Changes

### 1. Contradiction Detection in `facts.learn()`

**What:** After storing a new fact, check for existing facts with embedding similarity 0.85–0.95. This range means "same topic, different content" — above 0.95 is dedup (already handled), below 0.85 is unrelated.

**How:**
- New `_find_contradiction()` method — SQL query against `heart.facts` with cosine similarity range filter
- Returns `ContradictionWarning` attached to `FactDetail.contradiction_warning`
- Does NOT block the write — stores the fact and warns
- Logs at INFO level when contradiction detected
- Early return guard for empty embeddings

**Schema:**
```python
class ContradictionWarning(BaseModel):
    existing_fact_id: UUID
    existing_content: str  # truncated to 500 chars
    similarity: float
    message: str  # human-readable description
```

**Consumer:** Cognitive Layer (004) will surface these in context as "⚠️ Contradicting facts found — resolve before proceeding."

### 2. Domain Compaction Tracking

**What:** After storing a fact with a category, count active facts in that category. If count exceeds threshold, emit `fact_threshold_exceeded` event.

**How:**
- New `_check_domain_threshold()` method — `SELECT COUNT(*)` query
- Default threshold: 10 active facts per category (`DOMAIN_COMPACTION_THRESHOLD`)
- Anti-spam: only emits at threshold+1 and every `DOMAIN_COMPACTION_INTERVAL` (default 5) facts after
- No event emitted for facts without a category

**Event payload:**
```json
{
    "event_type": "fact_threshold_exceeded",
    "data": {
        "category": "technical",
        "count": 11,
        "threshold": 10
    }
}
```

**Consumer:** Event Bus (F006) will trigger LLM-based generalization — merge N specific facts into 1–3 general rules.

### 3. `check_contradictions` Flag

**What:** `learn(check_contradictions=False)` skips both contradiction detection and domain threshold checks.

**Why:** Bulk imports and internal operations (supersede, contradict) shouldn't pay the overhead of extra queries.

## Files Changed

| File | Change |
|------|--------|
| `nous/heart/facts.py` | +`_find_contradiction()`, +`_check_domain_threshold()`, updated `_learn()`, +class constants |
| `nous/heart/schemas.py` | +`ContradictionWarning` model, +`FactDetail.contradiction_warning` field |
| `nous/heart/__init__.py` | Export `ContradictionWarning` |
| `tests/test_fact_enhancements.py` | 9 tests covering both features + edge cases |

## Design Decisions

### D1: Warn, don't block
Contradictions are surfaced as warnings, not rejected. The Cognitive Layer (or the human) decides how to resolve. This matches LangChain's lesson: validation feedback loops work better than hard blocks.

### D2: Anti-spam on threshold events
Emit only at crossing point and at intervals, not on every subsequent learn(). Prevents event bus flooding when a category is actively growing.

### D3: Skip flag for internal operations
`supersede()` and `contradict()` call `_learn()` with `check_contradictions=False`. These are explicit resolution operations — checking for contradictions during contradiction resolution is circular.

### D4: Similarity range 0.85–0.95
Below 0.85 = different topic (too many false positives). Above 0.95 = dedup territory (already handled). The 0.85–0.95 band captures "same thing, different claim" — the actual contradiction zone.

## Test Coverage

| Test | What |
|------|------|
| `test_contradiction_detected` | New fact stored alongside existing, mechanism exercised |
| `test_no_contradiction_for_exact_dupe` | >0.95 similarity → dedup (confirm), not contradiction |
| `test_contradiction_warning_fields` | Warning schema validation |
| `test_domain_threshold_event_emitted` | Event fires when count > threshold |
| `test_domain_threshold_no_spam` | Event only fires at intervals, not every learn() |
| `test_domain_threshold_no_event_under_limit` | No event when under threshold |
| `test_domain_threshold_no_event_without_category` | No check when category is None |
| `test_skip_contradictions_flag` | `check_contradictions=False` skips all checks |
| `test_contradiction_warning_on_detail_is_optional` | Default is None |

## Review History

- Initial review: 3 P1s, 5 P2s found
- Fixes pushed: all P1s + 2 P2s addressed
- Re-review: approved, all issues resolved
