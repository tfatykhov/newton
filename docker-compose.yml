services:
  nous:
    build: .
    container_name: nous-agent
    ports:
      - "${NOUS_PORT:-8000}:8000"
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=nous
      - DB_PASSWORD=${DB_PASSWORD:-nous_dev_password}
      - DB_NAME=nous
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_AUTH_TOKEN=${ANTHROPIC_AUTH_TOKEN:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - NOUS_AGENT_ID=${NOUS_AGENT_ID:-nous-default}
      - NOUS_AGENT_NAME=${NOUS_AGENT_NAME:-Nous}
      - NOUS_MODEL=${NOUS_MODEL:-claude-sonnet-4-5-20250514}
      - NOUS_LOG_LEVEL=${NOUS_LOG_LEVEL:-info}
      - NOUS_MCP_ENABLED=${NOUS_MCP_ENABLED:-true}
      - NOUS_MAX_TURNS=${NOUS_MAX_TURNS:-10}
      - NOUS_THINKING_MODE=${NOUS_THINKING_MODE:-off}
      - NOUS_THINKING_BUDGET=${NOUS_THINKING_BUDGET:-10000}
      - NOUS_EFFORT=${NOUS_EFFORT:-high}
      - NOUS_WORKSPACE_DIR=${NOUS_WORKSPACE_DIR:-/tmp/nous-workspace}
      - BRAVE_SEARCH_API_KEY=${BRAVE_SEARCH_API_KEY:-}
      - NOUS_EVENT_BUS_ENABLED=${NOUS_EVENT_BUS_ENABLED:-true}
      - NOUS_EPISODE_SUMMARY_ENABLED=${NOUS_EPISODE_SUMMARY_ENABLED:-true}
      - NOUS_FACT_EXTRACTION_ENABLED=${NOUS_FACT_EXTRACTION_ENABLED:-true}
      - NOUS_SLEEP_ENABLED=${NOUS_SLEEP_ENABLED:-true}
      - NOUS_BACKGROUND_MODEL=${NOUS_BACKGROUND_MODEL:-claude-sonnet-4-5-20250514}
      - NOUS_SESSION_TIMEOUT=${NOUS_SESSION_TIMEOUT:-1800}
      - NOUS_SLEEP_TIMEOUT=${NOUS_SLEEP_TIMEOUT:-7200}
      - NOUS_SLEEP_CHECK_INTERVAL=${NOUS_SLEEP_CHECK_INTERVAL:-60}
      - NOUS_IDENTITY_PROMPT=${NOUS_IDENTITY_PROMPT:-}
      # Subtasks & Scheduling
      - NOUS_SUBTASK_ENABLED=${NOUS_SUBTASK_ENABLED:-true}
      - NOUS_SUBTASK_WORKERS=${NOUS_SUBTASK_WORKERS:-2}
      - NOUS_SUBTASK_POLL_INTERVAL=${NOUS_SUBTASK_POLL_INTERVAL:-2}
      - NOUS_SUBTASK_DEFAULT_TIMEOUT=${NOUS_SUBTASK_DEFAULT_TIMEOUT:-120}
      - NOUS_SUBTASK_MAX_TIMEOUT=${NOUS_SUBTASK_MAX_TIMEOUT:-600}
      - NOUS_SUBTASK_MAX_CONCURRENT=${NOUS_SUBTASK_MAX_CONCURRENT:-3}
      - NOUS_SCHEDULE_ENABLED=${NOUS_SCHEDULE_ENABLED:-true}
      - NOUS_SCHEDULE_CHECK_INTERVAL=${NOUS_SCHEDULE_CHECK_INTERVAL:-60}
      - NOUS_TELEGRAM_BOT_TOKEN=${NOUS_TELEGRAM_BOT_TOKEN:-}
      - NOUS_TELEGRAM_CHAT_ID=${NOUS_TELEGRAM_CHAT_ID:-}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  telegram:
    build: .
    container_name: nous-telegram
    command: python -m nous.telegram_bot
    environment:
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      NOUS_API_URL: http://nous:8000
      NOUS_ALLOWED_USERS: ${NOUS_ALLOWED_USERS:-}
    depends_on:
      - nous
    restart: unless-stopped

  postgres:
    image: pgvector/pgvector:pg17
    container_name: nous-postgres
    environment:
      POSTGRES_DB: nous
      POSTGRES_USER: nous
      POSTGRES_PASSWORD: ${DB_PASSWORD:-nous_dev_password}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./sql/init.sql:/docker-entrypoint-initdb.d/001-init.sql
      - ./sql/seed.sql:/docker-entrypoint-initdb.d/002-seed.sql
      - ./sql/migrations/010_subtasks.sql:/docker-entrypoint-initdb.d/003-subtasks.sql
    ports:
      - "${DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nous"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  pgdata:
